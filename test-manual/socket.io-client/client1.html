<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>My Website</title>
  <link rel="stylesheet" href="./style.css">
  <link rel="icon" href="./favicon.ico" type="image/x-icon">
</head>

<body>
  <main>
    <h1>Root Namespace Default Test UI</h1>
    <section>
      status: <span id="status">false</span>
      <br />
      <div>
        <button id="btnConnect">Connect</button>
        <button id="btnDisconnect">Disconnect</button>
      </div>
    </section>
    <hr>
    <section id="channels">
      <!--  -->
    </section>
    <section>
      <h5>ID: <b id="display-uuid"></b></h5>
      <ul id="chat"
        style="display: block;min-height:150px;max-height:150px;overflow-y: scroll;border: 1px solid black;padding:0;">
        <!--  -->
      </ul>
      <div>
        <input type="text" id="message">
        <button id="btnSend">send</button>
      </div>
    </section>
  </main>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script type="module">
    import { io } from "https://cdn.socket.io/4.3.2/socket.io.esm.min.js";
    import { v4 as uuidv4 } from 'https://jspm.dev/uuid';
    const channels = [
      "channel-1",
      "channel-2",
    ];
    const socket = io("http://localhost:1337/root", {
      autoConnect: false,
      transports: ["websocket", "polling"],
      query: {
        socket_key: "Rccueb3FOD32",
        socket_secret: "Saa0xRpK5hjjO4U3tQofEN81"
      }
    });

    socket.io.ns

    const module = {
      uuid: null,
      connected: false,
      room: null,
      domElement: $("html"),
      init() {
        module.uuid = uuidv4();
        module.dom();
        module.renderChannels();
        module.events();
        module.dispayUuid.text(module.uuid);
      },
      dom() {
        module.channels = module.domElement.find("#channels");
        module.status = module.domElement.find("#status");
        module.chat = module.domElement.find("#chat");
        module.btnConnect = module.domElement.find("#btnConnect");
        module.btnDisconnect = module.domElement.find("#btnDisconnect");
        module.dispayUuid = module.domElement.find("#display-uuid");
        module.message = module.domElement.find("#message");
        module.btnSend = module.domElement.find("#btnSend");
      },
      renderChannels() {
        channels.forEach((item, index) => {
          module.channels.append(`Name: ${item} | <button id="btnJoin${index}" data-channel="${item}">Join</button><button id="btnLeave${index}" data-channel="${item}">Leave</button><br/>`);
        });
      },
      join(e) {
        const channel = e.currentTarget.dataset.channel;
        if(module.room !== null) {
          socket.emit("leave:room", { room: module.room, payload: `${module.uuid} left the ${channel}.` });
        }
        if (!module.connected) {
          return console.log("Join not allowed, socket not connected.");
        }

        module.room = channel;
        console.log(channel);
        socket.emit("join:room", { room: channel, payload: `${module.uuid} joined the ${channel}.` });
      },
      leave(e) {
        const channel = e.currentTarget.dataset.channel;
        if (module.connected) {
          module.room = null;
          return socket.emit("leave:room", { room: e.currentTarget.dataset.channel, payload: `${module.uuid} left the ${channel}.` });
        }

        console.log("Leave not allowed, socket not connected.");
      },
      events() {
        $(document).on("click", `#btnJoin0`, module.join);
        $(document).on("click", `#btnJoin1`, module.join);
        $(document).on("click", `#btnLeave0`, module.leave);
        $(document).on("click", `#btnLeave1`, module.leave);
        module.btnSend.on("click", () => {
          if (module.connected) {
            socket.emit("trigger", { room: module.room, event: "message:room",  payload: { sender: module.uuid, message: `${module.message.val()}`} });
            return
          }

          console.log("Can't send message socket not connected.");
        });
        module.btnConnect.on("click", (e) => {
          socket.connect();
        });
        module.btnDisconnect.on("click", (e) => {
          if (module.connected) {
            socket.disconnect();
            socket.close();
            return
          }

          console.log("Can't disconnect socket is not connected.");
        });
        socket.on("connect", () => {
          console.log("Socket connected.");
          module.connected = socket.connected;
          module.status.text(module.connected);
        });
        socket.on("join:room", (payload) => {
          console.log(payload);
        });
        socket.on("leave:room", (payload) => {
          console.log(payload);
        });
        socket.on("message:room", (payload) => {
          if (payload.sender === module.uuid) {
            module.chat.append(`<li style="display:block;">${payload.message}</li>`);
          } else {
            module.chat.append(`<li style="display:block;text-align:right;">${payload.message}</li>`);
          }
        });
        socket.on("disconnect", () => {
          module.connected = false;
          module.room = null;
          module.status.text(module.connected);
        });
        socket.on("connect_error", (error) => {
          console.log(error);
          socket.close();
        });
      }
    }
    module.init();
  </script>
</body>

</html>